<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negozio Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #0f0f0f; min-height: 100vh; color: #fff; }
        
        .header { background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px 20px; text-align: center; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; }
        
        .products { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; padding-bottom: 80px; }
        .product { background: #1a1a1a; border-radius: 16px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .product:active { transform: scale(0.98); }
        .product-img { width: 100%; height: 120px; object-fit: cover; background: #2a2a2a; }
        .product-info { padding: 12px; }
        .product-name { font-size: 14px; font-weight: 600; }
        .product-price { font-size: 18px; font-weight: 700; color: #4ade80; margin-top: 5px; }
        .product-desc { font-size: 11px; color: #666; margin-top: 5px; }
        
        .empty { grid-column: span 2; text-align: center; padding: 50px; color: #666; }
        
        .cart-btn { position: fixed; bottom: 20px; right: 20px; background: #4ade80; color: #000; border: none; padding: 15px 25px; border-radius: 50px; font-weight: 700; font-size: 14px; box-shadow: 0 4px 20px rgba(74,222,128,0.4); }
        .admin-btn { position: fixed; bottom: 20px; left: 20px; background: #222; border: 2px solid #444; width: 50px; height: 50px; border-radius: 50%; font-size: 18px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f0f; z-index: 200; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { padding: 20px; padding-bottom: 40px; }
        .modal-header { background: linear-gradient(135deg, #f093fb, #f5576c); padding: 15px 20px; text-align: center; position: sticky; top: 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 16px; }
        .modal-header button { background: none; border: none; color: #fff; font-size: 24px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; }
        .form-group textarea { resize: none; height: 80px; }
        
        .img-upload { width: 100%; height: 100px; background: #1a1a1a; border: 2px dashed #333; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; margin-bottom: 8px; cursor: pointer; }
        .btn-green { background: #4ade80; color: #000; }
        .btn-blue { background: #3b82f6; color: #fff; }
        .btn-red { background: #ef4444; color: #fff; }
        .btn-gray { background: #333; color: #fff; }
        
        .cart-item { background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .cart-item-name { font-weight: 600; }
        .cart-item-price { color: #4ade80; }
        .cart-total { font-size: 20px; font-weight: 700; text-align: center; padding: 15px; background: #1a1a1a; border-radius: 10px; margin: 15px 0; }
        
        .order-card { background: #1a1a1a; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .order-id { font-weight: 700; color: #667eea; }
        .order-status { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .status-new { background: #f59e0b; color: #000; }
        .status-processing { background: #3b82f6; color: #fff; }
        .status-completed { background: #4ade80; color: #000; }
        
        .order-items { font-size: 13px; color: #aaa; margin-bottom: 10px; }
        .order-customer { font-size: 12px; color: #666; }
        .order-customer strong { color: #fff; }
        
        .order-actions { display: flex; gap: 8px; margin-top: 10px; }
        .order-actions button { flex: 1; padding: 8px; font-size: 12px; }
        
        .product-list-admin { margin-top: 20px; }
        .product-item { background: #1a1a1a; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .product-item img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
        .product-item-info { flex: 1; }
        .product-item-name { font-size: 14px; font-weight: 600; }
        .product-item-price { color: #4ade80; font-size: 14px; }
        .product-item-actions { display: flex; gap: 5px; }
        .product-item-actions button { padding: 6px 10px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; }
        
        .badge { background: #ef4444; color: #fff; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; position: absolute; top: -5px; right: -5px; }
        
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: #222; border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; }
        .tab-btn.active { background: #667eea; }
        
        .empty-orders { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="shopTitle">üõí Il Mio Negozio</h1>
        <div style="position: relative;">
            <span id="orderBadge" style="display:none;" class="badge">0</span>
        </div>
    </div>
    
    <div class="products" id="products"></div>
    
    <button class="admin-btn" onclick="openAdmin()">‚öôÔ∏è</button>
    <button class="cart-btn" onclick="openCart()">üõí Carrello <span id="cartCount">0</span></button>
    
    <!-- CART MODAL -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üõí Il Tuo Carrello</h2>
                <button onclick="closeCart()">√ó</button>
            </div>
            
            <div id="cartItems"></div>
            
            <div class="cart-total" id="cartTotal">Totale: ‚Ç¨0.00</div>
            
            <button class="btn btn-green" onclick="openCheckout()">‚úÖ VAI AL PAGAMENTO</button>
            <button class="btn btn-gray" onclick="closeCart()">‚Üê Torna al negozio</button>
        </div>
    </div>
    
    <!-- CHECKOUT MODAL -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Dati per la Consegna</h2>
                <button onclick="closeCheckout()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>üë§ Nome Completo</label>
                <input type="text" id="custName" placeholder="Mario Rossi">
            </div>
            
            <div class="form-group">
                <label>üì± Telefono</label>
                <input type="tel" id="custPhone" placeholder="+39 123 456 7890">
            </div>
            
            <div class="form-group">
                <label>üìç Indirizzo di Consegna</label>
                <textarea id="custAddress" placeholder="Via Roma 123, Milano"></textarea>
            </div>
            
            <div class="form-group">
                <label>üìù Note (opzionale)</label>
                <textarea id="custNotes" placeholder="Orario preferito, campanello, ecc."></textarea>
            </div>
            
            <button class="btn btn-green" onclick="submitOrder()">üì¶ CONFERMA ORDINE</button>
            <button class="btn btn-gray" onclick="closeCheckout()">‚Üê Torna al carrello</button>
        </div>
    </div>
    
    <!-- ORDER SUCCESS MODAL -->
    <div class="modal" id="successModal">
        <div class="modal-content" style="text-align: center; padding-top: 60px;">
            <div style="font-size: 80px;">üéâ</div>
            <h2 style="margin: 20px 0;">Ordine Inviato!</h2>
            <p style="color: #666; margin-bottom: 30px;">Grazie per il tuo ordine! Riceverai una conferma.</p>
            <button class="btn btn-green" onclick="closeSuccess()">üè† TORNA AL NEGOZIO</button>
        </div>
    </div>
    
    <!-- ADMIN PANEL -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Pannello Admin</h2>
                <button onclick="closeAdmin()">√ó</button>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('orders')" id="tabOrders">üì¶ Ordini <span id="orderCount">0</span></button>
                <button class="tab-btn" onclick="switchTab('products')" id="tabProducts">üìù Prodotti</button>
            </div>
            
            <!-- ORDERS TAB -->
            <div id="ordersTab">
                <div id="ordersList"></div>
            </div>
            
            <!-- PRODUCTS TAB -->
            <div id="productsTab" style="display: none;">
                <div class="form-group">
                    <label>üì∑ Foto</label>
                    <div class="img-upload" onclick="document.getElementById('imgInput').click()">
                        <span id="imgPlaceholder">üì∑ Clicca per foto</span>
                        <img id="imgPreview" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:10px;">
                    </div>
                    <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleImg(event)">
                </div>
                
                <div class="form-group">
                    <label>üìù Nome Prodotto</label>
                    <input type="text" id="prodName" placeholder="Es. Pizza Margherita">
                </div>
                
                <div class="form-group">
                    <label>üí∞ Prezzo (‚Ç¨)</label>
                    <input type="number" id="prodPrice" placeholder="8.00" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>üìÑ Descrizione (opzionale)</label>
                    <textarea id="prodDesc" placeholder="Ingredienti, caratteristiche..."></textarea>
                </div>
                
                <button class="btn btn-green" onclick="saveProduct()">üíæ SALVA PRODOTTO</button>
                
                <div class="product-list-admin" id="productListAdmin"></div>
            </div>
            
            <button class="btn btn-red" style="margin-top:20px" onclick="closeAdmin()">‚ùå CHIUDI</button>
        </div>
    </div>
    
    <script>
        const tg = Telegram.WebApp;
        tg.expand();
        
        // Get shop from URL
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('shop') || 'default';
        
        // Storage keys
        const PRODUCTS_KEY = 'shop_products_' + shopId;
        const ORDERS_KEY = 'shop_orders_' + shopId;
        const ADMIN_KEY = 'shop_admin_' + shopId;
        
        // State
        let products = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]');
        let orders = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]');
        let cart = [];
        let editingIdx = null;
        
        // Demo products if empty
        if (products.length === 0) {
            products = [
                { name: 'Pizza Margherita', price: '8.00', desc: 'Pomodoro, mozzarella, basilico', img: 'https://images.unsplash.com/photo-1604068549290-dea0e4a305f4?w=300' },
                { name: 'Hamburger', price: '10.00', desc: 'Carne, formaggio, lattuga', img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=300' },
                { name: 'Insalata Mista', price: '6.00', desc: 'Verdure fresche', img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=300' },
                { name: 'Bibita', price: '3.00', desc: 'Coca Cola, Fanta, Sprite', img: 'https://images.unsplash.com/photo-1581006852262-e4307cf6283a?w=300' }
            ];
            localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
        }
        
        // Render products
        function render() {
            const c = document.getElementById('products');
            if (!products.length) {
                c.innerHTML = '<div class="empty">üì¶ Nessun prodotto<br>Clicca ‚öôÔ∏è per aggiungere</div>';
                return;
            }
            c.innerHTML = products.map((p, i) => `
                <div class="product" onclick="addToCart(${i})">
                    <img src="${p.img}" class="product-img" onerror="this.src='https://via.placeholder.com/300x200?text=Foto'">
                    <div class="product-info">
                        <div class="product-name">${p.name}</div>
                        <div class="product-desc">${p.desc || ''}</div>
                        <div class="product-price">‚Ç¨${p.price}</div>
                    </div>
                </div>
            `).join('');
            renderProductListAdmin();
            updateOrderBadge();
        }
        
        // Cart functions
        function addToCart(i) {
            cart.push(products[i]);
            document.getElementById('cartCount').innerText = cart.length;
            tg.showAlert('‚úÖ Aggiunto: ' + products[i].name);
        }
        
        function openCart() {
            if (!cart.length) return tg.showAlert('üõí Il carrello √® vuoto!');
            document.getElementById('cartModal').classList.add('active');
            renderCart();
        }
        
        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }
        
        function renderCart() {
            const container = document.getElementById('cartItems');
            if (!cart.length) {
                container.innerHTML = '<div class="empty-orders">üõí Carrello vuoto</div>';
                return;
            }
            container.innerHTML = cart.map((p, i) => `
                <div class="cart-item">
                    <div>
                        <div class="cart-item-name">${p.name}</div>
                        <div class="cart-item-price">‚Ç¨${p.price}</div>
                    </div>
                    <button style="background:#ef4444;color:#fff;padding:5px 10px;border:none;border-radius:5px;cursor:pointer;" onclick="removeFromCart(${i})">‚úï</button>
                </div>
            `).join('');
            const total = cart.reduce((s, p) => s + parseFloat(p.price), 0);
            document.getElementById('cartTotal').innerText = 'Totale: ‚Ç¨' + total.toFixed(2);
        }
        
        function removeFromCart(i) {
            cart.splice(i, 1);
            document.getElementById('cartCount').innerText = cart.length;
            renderCart();
        }
        
        // Checkout
        function openCheckout() {
            closeCart();
            document.getElementById('checkoutModal').classList.add('active');
        }
        
        function closeCheckout() {
            document.getElementById('checkoutModal').classList.remove('active');
        }
        
        function submitOrder() {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const address = document.getElementById('custAddress').value.trim();
            const notes = document.getElementById('custNotes').value.trim();
            
            if (!name || !phone || !address) {
                tg.showAlert('‚ö†Ô∏è Compila tutti i campi obbligatori!');
                return;
            }
            
            const total = cart.reduce((s, p) => s + parseFloat(p.price), 0);
            const orderId = 'ORD-' + Date.now().toString(36).toUpperCase();
            
            const order = {
                id: orderId,
                products: [...cart],
                total: total,
                customer: { name, phone, address, notes },
                status: 'new',
                createdAt: new Date().toISOString()
            };
            
            orders.unshift(order);
            localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
            
            // Send to Telegram bot
            const orderMsg = `üì¶ NUOVO ORDINE!\n\n` +
                `ID: ${orderId}\n` +
                `Cliente: ${name}\n` +
                `Tel: ${phone}\n` +
                `Indirizzo: ${address}\n\n` +
                `üõí PRODOTTI:\n` +
                cart.map(p => `‚Ä¢ ${p.name} - ‚Ç¨${p.price}`).join('\n') + `\n\n` +
                `üí∞ TOTALE: ‚Ç¨${total.toFixed(2)}`;
            
            try {
                tg.sendData(orderMsg);
            } catch(e) {
                console.log('Cannot send to bot:', e);
            }
            
            // Clear cart
            cart = [];
            document.getElementById('cartCount').innerText = '0';
            
            // Clear form
            document.getElementById('custName').value = '';
            document.getElementById('custPhone').value = '';
            document.getElementById('custAddress').value = '';
            document.getElementById('custNotes').value = '';
            
            closeCheckout();
            document.getElementById('successModal').classList.add('active');
            updateOrderBadge();
        }
        
        function closeSuccess() {
            document.getElementById('successModal').classList.remove('active');
        }
        
        // Admin
        function openAdmin() {
            document.getElementById('adminModal').classList.add('active');
            renderOrders();
        }
        
        function closeAdmin() {
            document.getElementById('adminModal').classList.remove('active');
        }
        
        function switchTab(tab) {
            document.getElementById('tabOrders').classList.toggle('active', tab === 'orders');
            document.getElementById('tabProducts').classList.toggle('active', tab === 'products');
            document.getElementById('ordersTab').style.display = tab === 'orders' ? 'block' : 'none';
            document.getElementById('productsTab').style.display = tab === 'products' ? 'block' : 'none';
        }
        
        function renderOrders() {
            const container = document.getElementById('ordersList');
            document.getElementById('orderCount').innerText = orders.length;
            
            if (!orders.length) {
                container.innerHTML = '<div class="empty-orders">üì¶ Nessun ordine</div>';
                return;
            }
            
            container.innerHTML = orders.map((o, i) => {
                const statusClass = o.status === 'new' ? 'status-new' : o.status === 'processing' ? 'status-processing' : 'status-completed';
                const statusText = o.status === 'new' ? 'NUOVO' : o.status === 'processing' ? 'IN LAVORAZIONE' : 'COMPLETATO';
                const items = o.products.map(p => `${p.name} (‚Ç¨${p.price})`).join(', ');
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <span class="order-id">${o.id}</span>
                            <span class="order-status ${statusClass}" onclick="changeStatus(${i})">${statusText}</span>
                        </div>
                        <div class="order-items">üõí ${items}</div>
                        <div class="order-customer">
                            <strong>üë§ ${o.customer.name}</strong><br>
                            üì± ${o.customer.phone}<br>
                            üìç ${o.customer.address}
                            ${o.customer.notes ? '<br>üìù ' + o.customer.notes : ''}
                        </div>
                        <div class="order-total" style="margin:10px 0;padding:10px;font-size:16px;">
                            üí∞ TOTALE: ‚Ç¨${o.total.toFixed(2)}
                        </div>
                        <div class="order-actions">
                            <button class="btn btn-blue" onclick="changeStatus(${i})">üîÑ Stato</button>
                            <button class="btn btn-red" onclick="deleteOrder(${i})">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function changeStatus(i) {
            const statuses = ['new', 'processing', 'completed'];
            const current = statuses.indexOf(orders[i].status);
            orders[i].status = statuses[(current + 1) % statuses.length];
            localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
            renderOrders();
            updateOrderBadge();
        }
        
        function deleteOrder(i) {
            tg.showConfirm('üóëÔ∏è Elimina ordine?', (c) => {
                if (c) {
                    orders.splice(i, 1);
                    localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
                    renderOrders();
                    updateOrderBadge();
                }
            });
        }
        
        function updateOrderBadge() {
            const newOrders = orders.filter(o => o.status === 'new').length;
            const badge = document.getElementById('orderBadge');
            if (newOrders > 0) {
                badge.style.display = 'flex';
                badge.innerText = newOrders;
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Products admin
        function handleImg(e) {
            const f = e.target.files[0];
            if (f) {
                const r = new FileReader();
                r.onload = ev => {
                    document.getElementById('imgPreview').src = ev.target.result;
                    document.getElementById('imgPreview').style.display = 'block';
                    document.getElementById('imgPlaceholder').style.display = 'none';
                };
                r.readAsDataURL(f);
            }
        }
        
        function saveProduct() {
            const name = document.getElementById('prodName').value.trim();
            const price = document.getElementById('prodPrice').value.trim();
            const desc = document.getElementById('prodDesc').value.trim();
            const img = document.getElementById('imgPreview').src || 'https://via.placeholder.com/300x200';
            
            if (!name || !price) return tg.showAlert('‚ö†Ô∏è Scrivi nome e prezzo!');
            
            if (editingIdx !== null) {
                products[editingIdx] = { name, price, desc, img };
                editingIdx = null;
            } else {
                products.push({ name, price, desc, img });
            }
            
            localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
            render();
            clearForm();
            tg.showAlert('‚úÖ Salvato!');
        }
        
        function renderProductListAdmin() {
            document.getElementById('productListAdmin').innerHTML = products.map((p, i) => `
                <div class="product-item">
                    <img src="${p.img}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="product-item-info">
                        <div class="product-item-name">${p.name}</div>
                        <div class="product-item-price">‚Ç¨${p.price}</div>
                    </div>
                    <div class="product-item-actions">
                        <button style="background:#3b82f6;color:#fff;" onclick="editProduct(${i})">‚úèÔ∏è</button>
                        <button style="background:#ef4444;color:#fff;" onclick="deleteProduct(${i})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editProduct(i) {
            editingIdx = i;
            document.getElementById('prodName').value = products[i].name;
            document.getElementById('prodPrice').value = products[i].price;
            document.getElementById('prodDesc').value = products[i].desc || '';
            document.getElementById('imgPreview').src = products[i].img;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('imgPlaceholder').style.display = 'none';
            tg.showAlert('‚úèÔ∏è Modifica e SALVA');
        }
        
        function deleteProduct(i) {
            tg.showConfirm('üóëÔ∏è Elimina prodotto?', (c) => {
                if (c) {
                    products.splice(i, 1);
                    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
                    render();
                }
            });
        }
        
        function clearForm() {
            document.getElementById('prodName').value = '';
            document.getElementById('prodPrice').value = '';
            document.getElementById('prodDesc').value = '';
            document.getElementById('imgPreview').src = '';
            document.getElementById('imgPreview').style.display = 'none';
            document.getElementById('imgPlaceholder').style.display = 'flex';
        }
        
        // Init
        render();
    </script>
</body>
</html>
